<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <title>Demo</title>
    <link rel="stylesheet" href="/main/wwwroot/wdt-emoji-bundle.css" />
    <script src="/main/wwwroot/emoji.min.js" type="text/javascript"></script>
    <script src="/main/wwwroot/moment.min.js" type="text/javascript"></script>
    <style>
        * {
            font-family: Slack-Lato,appleLogo,sans-serif;
            color: #2C2D30;
            font-size: 15px;
            line-height: 22px;
        }
        .userIcon
        {   
            width: 32px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <script> 
        var  wsUri = "ws://" + window.location.host + "/socket"; 
        var output, websocket;
        var emoji = new EmojiConvertor();

        function init() { 
            output = document.getElementById("output");

            emoji.img_sets = {
                'apple': { 'sheet': '/main/wwwroot/sheets/sheet_apple_64_indexed_128.png', 'mask': 1 }
            };
            emoji.img_set = 'apple'; 
            emoji.use_sheet = true; 

            emoji.init_env(); 
              
            websocket = new WebSocket(wsUri);
            websocket.onopen = function (evt) { onOpen(evt); };
            websocket.onclose = function (evt) { onClose(evt); };
            websocket.onmessage = function (evt) { onMessage(evt); };
            websocket.onerror = function (evt) { onError(evt); };
            setInterval(function () {
                var elms = document.querySelectorAll('span.on');
                for (i = 0; i < elms.length; i++) { 
                    elms[i].innerHTML = moment(elms[i].getAttribute('data-on')).fromNow();
                }
            }, 1000);
        }
        function onOpen(evt) {
            console.log("CONNECTED"); 
        }
        function onClose(evt) {
            console.log("DISCONNECTED");
        }
        function onMessage(evt) {
            var event = JSON.parse(evt.data);
            var formated = applyFormat(event.message);
            formated = emoji.replace_colons(formated);
            var date = moment(event.on).fromNow();
            writeToScreen('<span class="message" id="' + event.messageId + '"><span class="sender"><img class="userIcon" src="' + event.senderIcon+'" />' + event.senderName + ': </span>' + formated + '</span><br><span class="on" data-on="'+event.on+'">' + date + '</span>');
            return true;
        }

        function applyFormat(text)
        {
            return text.replace(/\*(\w*)\*/g, '<b>$1</b>')
                .replace(/\_(\w*)\_/g, '<i>$1</i>')
                .replace(/\~(\w*)\~/g, '<del>$1</del>')
                .replace(/\`(\w*)\`/g, '<span class="code">$1</span>')
                .replace(/\`\`\`(\w*)\`\`\`/g, '<span class="preformated">$1</span>')
                .replace(/\>(\w*)\*/g, '<span class="quote">$1</span>');
        }

        function onError(evt) {
            console.log(evt.data);
        }
       
        function writeToScreen(message) {
            var pre = document.createElement("p") 
            pre.innerHTML = message;
            output.appendChild(pre);
        }
        window.addEventListener("load", init, false);
    </script>
    <h2>Output</h2> 
    <div id="output"></div>

</body>
</html>